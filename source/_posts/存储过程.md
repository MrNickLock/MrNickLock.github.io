---
title: 存储过程
date: 2017-08-14 20:05:06
tags:
---

```sql
CREATE OR REPLACE PROCEDURE Pro_R_PolUnderInfo(v_flag      Varchar2,
                                         v_ComCode   Varchar2,
                                         v_Day       int,
                                         v_StartDate Varchar2,
                                         v_EndDate   Varchar2) AS
  --##############################程序说明区域################################
  --#@DESC   全险种承保业务统计报表
  --#数据来源：
            /*  */
  --#前置任务：无
  --#后续任务：无
  --#执行频率：每天
  --#特别关注：
  --#@@AUTHOR：   MODIFY BY QIANTINGTING
  --#@CREATEDATE：2017/7/19

  --##############################参数区域################################
  i_flag      Varchar2(3); --提数方式
  i_ComCode   Varchar2(8); --提数机构
  i_Day       int;
  i_StartDate Date; --开始日期
  i_EndDate   Date; --结束日期
  v_sqlText   Varchar2(30000); --SQL语句
  i_Pro_id    Varchar(100); --过程ID
  i_Pro_name  Varchar2(100); --过程名称
  i_errorcode Number; --错误代码
  i_errormsg  Varchar2(254); --错误消息
  i_errorinfo Varchar2(254); --错误信息
  i_SDate     Date; --开始提数日期
  i_EDate     Date; --提数结束日期

  --##############################过程体###################################
BEGIN
  i_flag      := v_flag;
  i_SDate     := Sysdate;
  i_ComCode   := v_ComCode;
  i_Day       := v_Day;
 --i_StartDate := to_date(v_StartDate, 'yyyy-mm-dd');
 -- i_EndDate   := to_date(v_EndDate, 'yyyy-mm-dd');
  i_Pro_name  := 'R表全险种承保业务统计报表';
  i_Pro_id    := 'Pro_R_PolUnderInfo';

IF v_StartDate IS NULL
  THEN
    i_StartDate := SYSDATE-1;
  ELSE
    i_StartDate := to_date(v_StartDate, 'yyyy-mm-dd');
END IF
;

IF v_EndDate IS NULL
  THEN
    i_EndDate := SYSDATE-1;
  ELSE
    i_EndDate := to_date(v_EndDate, 'yyyy-mm-dd');
END IF
;





EXECUTE IMMEDIATE 'TRUNCATE TABLE T_R_PolUnderInfo_T01';
INSERT INTO T_R_PolUnderInfo_T01
SELECT
       PolicyNo
     , ComCode
     , RiskCode      --险种代码
     , '0' AS BusFlag     --新续转  0：新单 1：续，2、转　
     , ChannelDetailCode AS Channel1Code
     , ChannelTip        AS Channel2Code
     , CertiType     --保批单类型  P保单;E批单
     , EndorType     --批改类型 对保单是"00"
     , StartValidDate--起保生效日期 对保单是起保；批单是生效
     , UnderDate     --核保完成日期 对批单是核批完成日期
     , MaxDate       --对于保单是起保核保日期大者；对于批单是核批生效日期大者
     , UnderFlag
     , SUBSTR(BusiFlag, 3, 1) AS SurrenderFlag --退保标志
     , SUBSTR(BusiFlag, 5, 1) AS CancelFlag    --注销标志
     , Commission
     , SumAmount
     , SumPremium
     , OurCoinsAmount --共保我方保额 SumAmount*CoinsRate
     , NOTAXPREMIUM AS  OurCoinsPrem   --共保我方保费 SumPremium*CoinsRate（去税后）
     , BasePrem
     , BenchmarkPrem
     , '0' AS DamageLst
     , TaxAmount
  FROM F_CopyMain
 WHERE 1=1
   -- AND RiskCode LIKE '08%'
   AND UnderFlag IN ('6') --6 承保确认
/*AND
  ( UnderDate = TO_CHAR(SYSDATE - 1, 'YYYY-MM-DD') OR --核保或核批在统计日
       --MaxDate为了计算保费收入
      MaxDate = TO_CHAR(SYSDATE - 1, 'YYYY-MM-DD') --起保核保大者在统计日
  )*/
;


EXECUTE IMMEDIATE 'TRUNCATE TABLE T_R_PolUnderInfo_T02';
INSERT INTO T_R_PolUnderInfo_T02
--签单口径
SELECT UnderDate       AS StatDate --统计日期
       --为了下一步获取保单保费，这里需要保单号
     , PolicyNo
     , ComCode
     , RiskCode      --险种代码
     , a.StartValidDate --起保、生效日期
     , BusFlag          --新续转  0：新单 1：续，2、转
     , Channel1Code
     , Channel2Code
     , OurCoinsPrem    AS SignPrem --统计保费:签单保费
     , decode(CertiType,'P',OurCoinsPrem,0) as YSignPrem  --原始保单保费        20170807应客户需求添加
     , OurCoinsAmount  AS SignAmount --签单保额
       --不管你何时批改，都应该列出最原始的保单保费
       --保单件数，跟保单保费不一样，保单保费是签单就有的原始保费
       --但保单件数应该是签单口径内的保单件数
       --所以保单件数放在这里计算，而签单保费是放在下面计算的
      , 0.00 AS EndorIncrsCnt       --批增件数
       --批增保费是指对承保保单相关信息进行变更而导致签单保费增加的批改保费
     , 0.00 AS EndorIncrsPrem      --批增保费
     , 0.00 AS EndorIncrsAmount    --批增保额
     , 0.00 AS EndorDecrsCnt  --批减件数
     , 0.00 AS EndorDecrsPrem  --批减保费
     , 0.00 AS EndorDecrsAmount --批减保额
     , 0.00 AS CancelCount --注销件数
     , 0.00 AS CancelPrem --注销保费
     , 0.00 AS CancelAmount --注销保额
     , 0.00 AS SurrenderCount --退保件数
     , 0.00 AS SurrenderPrem --退保保费
     , 0.00 AS SurrenderAmount --退保保额
     , 0.00 AS AllSrrndrCnt --全单退保件数
     , 0.00 AS Commission
     , 0.00 AS SumAmount
     , 0.00 AS SumPremium
     , 0.00 AS BasePrem
     , CASE
         --批单的标准保费，在计算折扣率时，不能计算在内。
         WHEN CertiType = 'P' THEN BenchmarkPrem
         ELSE 0
         END  AS BenchmarkPrem
     , DamageLst
     , 0.00 AS SumPrem       --保费收入（不含税）
     , 0.00 AS PolicyCount   --保单件数
     , 0.00 AS PolicyAmount  --保单保额
     , 0.00 AS TaxAmount     --税额
  FROM T_R_PolUnderInfo_T01 a
 WHERE 1=1
   AND a.UnderDate BETWEEN i_StartDate AND i_EndDate
;

--保费收入口径
--与上面的签单口径的程序是一样的
--差别在于第一个字段和最后的WHERE条件
INSERT INTO T_R_PolUnderInfo_T02
SELECT a.MaxDate       AS StatDate --统计日期
       --为了下一步获取保单保费，这里需要保单号
     , PolicyNo
     , ComCode
     , RiskCode      --险种代码
     , a.StartValidDate --起保、生效日期
     , BusFlag          --新续转  0：新单 1：续，2、转
     , Channel1Code
     , Channel2Code
     , 0.00 AS SignPrem --统计保费:签单保费
     , 0.00 AS YSignPrem --原始保单保费
     , 0.00 AS SignAmount --签单保额
    , CASE
         --批改导致保费增加
         WHEN CertiType = 'E' AND OurCoinsPrem > 0 THEN 1
         ELSE 0
       END AS EndorIncrsCnt       --批增件数
       --批增保费是指对承保保单相关信息进行变更而导致签单保费增加的批改保费
     , CASE
         --批改导致保费增加
         WHEN CertiType = 'E' AND OurCoinsPrem > 0 THEN OurCoinsPrem
         ELSE 0
       END AS EndorIncrsPrem      --批增保费
     , CASE
         WHEN CertiType = 'E' AND OurCoinsAmount > 0 THEN OurCoinsAmount
         ELSE 0
       END AS EndorIncrsAmount    --批增保额

     , CASE
         WHEN CertiType = 'E' AND --批单
              EndorType NOT LIKE '%16%' AND --全单退保
              EndorType NOT LIKE '%50%' AND --变更承保险别（退保）
              EndorType NOT LIKE '%64%' AND --全单退保(不含交强险)
              EndorType NOT LIKE '%81%' AND --未满期退保
              EndorType NOT LIKE '%80%' AND --未满期退保
              EndorType NOT LIKE '%82%' AND --满期退保
              EndorType NOT LIKE '%15%' AND --注销
              OurCoinsPrem < 0    --导致保费减少
           THEN 1
         ELSE 0
       END AS EndorDecrsCnt  --批减件数
       --批减保费是指对承保保单进行除退保和注销之外的保单信息进行变更
       --而导致签单保费减少的批改保费
     , CASE
         WHEN CertiType = 'E' AND --批单
              EndorType NOT LIKE '%16%' AND --全单退保
              EndorType NOT LIKE '%50%' AND --变更承保险别（退保）
              EndorType NOT LIKE '%64%' AND --全单退保(不含交强险)
              EndorType NOT LIKE '%81%' AND --未满期退保
              EndorType NOT LIKE '%80%' AND --未满期退保
              EndorType NOT LIKE '%82%' AND --满期退保
              EndorType NOT LIKE '%15%' AND --注销
              OurCoinsPrem < 0    --导致保费减少
           THEN OurCoinsPrem
         ELSE 0
       END AS EndorDecrsPrem  --批减保费
     , CASE
         WHEN CertiType = 'E' AND --批单
              EndorType NOT LIKE '%16%' AND --全单退保
              EndorType NOT LIKE '%50%' AND --变更承保险别（退保）
              EndorType NOT LIKE '%64%' AND --全单退保(不含交强险)
              EndorType NOT LIKE '%81%' AND --未满期退保
              EndorType NOT LIKE '%80%' AND --未满期退保
              EndorType NOT LIKE '%82%' AND --满期退保
              EndorType NOT LIKE '%15%' AND --注销
              OurCoinsAmount < 0    --导致保额减少
           THEN OurCoinsAmount
         ELSE 0
       END AS EndorDecrsAmount --批减保额

       --注销件数,是指对承保保单进行注销的批单件数
     , CASE
         WHEN EndorType LIKE '%15%' THEN 1
         ELSE 0
       END AS CancelCount --注销件数
     , CASE
              --保单的批改类型为00，不可能出险15的情况，
         WHEN EndorType LIKE '%15%' THEN OurCoinsPrem
         ELSE 0
       END AS CancelPrem --注销保费
     , CASE
         WHEN EndorType LIKE '%15%' THEN OurCoinsAmount
         ELSE 0
       END AS CancelAmount --注销保额

     , CASE
         WHEN EndorType LIKE '%16%' OR --全单退保
              EndorType LIKE '%50%' OR --变更承保险别（退保）
              EndorType LIKE '%64%' OR --全单退保(不含交强险)
              EndorType LIKE '%81%' OR --未满期退保
              EndorType LIKE '%80%' OR --未满期退保
              EndorType LIKE '%82%'    --满期退保
          THEN 1
         ELSE 0
       END AS SurrenderCount --退保件数
     , CASE
              --保单的批改类型为00 ，不可能出险16 的情况，
         WHEN EndorType LIKE '%16%' OR --全单退保
              EndorType LIKE '%50%' OR --变更承保险别（退保）
              EndorType LIKE '%64%' OR --全单退保(不含交强险)
              EndorType LIKE '%81%' OR --未满期退保
              EndorType LIKE '%80%' OR --未满期退保
              EndorType LIKE '%82%'    --满期退保
           THEN OurCoinsPrem
         ELSE 0
       END AS SurrenderPrem --退保保费
     , CASE
              --保单的批改类型为00，不可能出险16的情况，
         WHEN EndorType LIKE '%16%' OR --全单退保
              EndorType LIKE '%50%' OR --变更承保险别（退保）
              EndorType LIKE '%64%' OR --全单退保(不含交强险)
              EndorType LIKE '%81%' OR --未满期退保
              EndorType LIKE '%80%' OR --未满期退保
              EndorType LIKE '%82%'    --满期退保
           THEN OurCoinsAmount
         ELSE 0
       END AS SurrenderAmount --退保保额

     , CASE
         WHEN EndorType LIKE '%16%' THEN 1
          --全单退保
         ELSE 0
       END AS AllSrrndrCnt --全单退保件数
     , Commission AS Commission
     , 0.00 AS SumAmount
     , 0.00 AS SumPremium
     , 0.00 AS BasePrem
     , 0.00 AS BenchmarkPrem
     , DamageLst
     , OurCoinsPrem    AS SumPrem --保费收入（不含税）
     , OurCoinsAmount  AS PolicyAmount  --保单保额
     , CASE WHEN a.CertiType = 'P' THEN 1 ELSE 0 END  AS PolicyCount   --保单件数
     , TaxAmount AS TaxAmount     --税额
  FROM T_R_PolUnderInfo_T01 a
 WHERE 1=1
   AND a.MaxDate BETWEEN i_StartDate AND i_EndDate
;

EXECUTE IMMEDIATE 'TRUNCATE TABLE R_PolUnderInfo';
INSERT INTO R_PolUnderInfo
SELECT StatDate --统计日期
     , ComCode
     , RiskCode      --险种代码
     , StartValidDate --起保、生效日期
     , BusFlag          --新续转  0：新单 1：续，2、转
     , Channel1Code
     , Channel2Code
     , SUM(SignPrem)         AS SignPrem --统计保费:签单保费
     , SUM(YSignPrem)         AS YSignPrem --原始保单保费
     , SUM(SignAmount)       AS SignAmount --签单保额
     , SUM(EndorIncrsCnt)    AS EndorIncrsCnt       --批增件数
     , SUM(EndorIncrsPrem)   AS EndorIncrsPrem     --批增保费
     , SUM(EndorIncrsAmount) AS EndorIncrsAmount   --批增保额
     , SUM(EndorDecrsCnt)    AS EndorDecrsCnt  --批减件数
     , SUM(EndorDecrsPrem)   AS EndorDecrsPrem  --批减保费
     , SUM(EndorDecrsAmount) AS EndorDecrsAmount --批减保额
     , SUM(CancelCount)     AS CancelCount    --注销件数
     , SUM(CancelPrem)      AS CancelPrem--注销保费
     , SUM(CancelAmount)    AS CancelAmount--注销保额
     , SUM(SurrenderCount)  AS SurrenderCount --退保件数
     , SUM(SurrenderPrem)   AS SurrenderPrem --退保保费
     , SUM(SurrenderAmount) AS SurrenderAmount --退保保额
     , SUM(AllSrrndrCnt) AS AllSrrndrCnt --全单退保件数
     , SUM(Commission) AS Commission  --手续费
     , SUM(SumAmount)  AS SumAmount   --保额
     , SUM(SumPremium) AS SumPremium  --保费
     , SUM(BasePrem)   AS BasePrem    --基准保费
     , SUM(BenchmarkPrem) AS BenchmarkPrem  --标准保费
     , SUM(DamageLst)     AS DamageLst     --上年出险次数
     , SUM(SumPrem)      AS SumPrem --保费收入（不含税）
     , SUM(PolicyAmount) AS PolicyAmount  --保单保额
     , SUM(PolicyCount)  AS PolicyCount --保单件数
     , SUM(TaxAmount)    AS TaxAmount     --税额
     , TO_CHAR(SYSDATE,'YYYY-MM-DD HH24:MI:SS') AS UPDATETIME
  FROM T_R_PolUnderInfo_T02 a
 GROUP BY
       StatDate --统计日期
     , ComCode
     , RiskCode      --险种代码
     , StartValidDate --起保、生效日期
     , BusFlag          --新续转  0：新单 1：续，2、转
     , Channel1Code
     , Channel2Code
;

COMMIT;

--#############################记录日志###################################
  i_EDate := Sysdate;
  Insert Into S_log
  Values
    (i_Pro_id,
     i_Pro_name,
     i_flag,
     i_ComCode,
     i_Day,
     i_StartDate,
     i_EndDate,
     i_SDate,
     i_EDate,
     0,
     0000,
     'no errors',
     'no errors',
     'no errors');
  Commit;

Exception
  When Others Then
    i_Pro_id    := 'Pro_R_PolUnderInfo';
    i_EDate     := Sysdate;
    i_errorcode := Sqlcode;
    i_errormsg  := Sqlerrm;
    i_errorinfo := TO_CHAR(i_errorcode) || '    ' || i_errormsg;
    Begin
      Rollback;
      Insert Into S_log
      Values
        (i_Pro_id,
         i_Pro_name,
         i_flag,
         i_ComCode,
         i_Day,
         i_StartDate,
         i_EndDate,
         i_SDate,
         i_EDate,
         1,
         i_errorcode,
         i_errormsg,
         i_errorinfo,
         v_sqlText);
      Commit;
    End;
End;


```
